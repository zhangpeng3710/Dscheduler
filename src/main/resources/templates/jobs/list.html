<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout.html}">
<head>
    <title>Job List</title>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <h2>定时任务列表</h2>

        <!-- Success Message -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Error Message -->
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div class="mb-3">
            <a th:href="@{/jobs/new}" class="btn btn-primary"><i class="fas fa-plus-circle"></i> 添加定时任务</a>
        </div>

        <div th:if="${jobs == null or jobs.isEmpty()}" class="alert alert-info">
            No jobs scheduled yet.
        </div>

        <table th:if="${jobs != null and not jobs.isEmpty()}" class="table table-striped table-hover" id="jobsTable">
            <thead class="table-dark">
            <tr>
                <th class="sortable" data-sort="jobName" th:classappend="${sortField == 'jobName' ? 'sorted ' + (sortOrder == 'asc' ? 'sort-asc' : 'sort-desc') : ''}">
                    名称
                    <i class="fas fa-sort ms-1"></i>
                    <i class="fas fa-sort-up ms-1" th:if="${sortField == 'jobName' and sortOrder == 'asc'}"></i>
                    <i class="fas fa-sort-down ms-1" th:if="${sortField == 'jobName' and sortOrder == 'desc'}"></i>
                </th>
                <th class="sortable" data-sort="jobGroup" th:classappend="${sortField == 'jobGroup' ? 'sorted ' + (sortOrder == 'asc' ? 'sort-asc' : 'sort-desc') : ''}">
                    分组
                    <i class="fas fa-sort ms-1"></i>
                    <i class="fas fa-sort-up ms-1" th:if="${sortField == 'jobGroup' and sortOrder == 'asc'}"></i>
                    <i class="fas fa-sort-down ms-1" th:if="${sortField == 'jobGroup' and sortOrder == 'desc'}"></i>
                </th>
                <th>任务类</th>
                <th>Cron表达式</th>
                <th>描述</th>
                <th class="sortable" data-sort="triggerState" th:classappend="${sortField == 'triggerState' ? 'sorted ' + (sortOrder == 'asc' ? 'sort-asc' : 'sort-desc') : ''}">
                    状态
                    <i class="fas fa-sort ms-1"></i>
                    <i class="fas fa-sort-up ms-1" th:if="${sortField == 'triggerState' and sortOrder == 'asc'}"></i>
                    <i class="fas fa-sort-down ms-1" th:if="${sortField == 'triggerState' and sortOrder == 'desc'}"></i>
                </th>
                <th>下次运行时间</th>
                <th>上次运行时间</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="job : ${jobs}">
                <td th:text="${job.jobName}"></td>
                <td th:text="${job.jobGroup}"></td>
                <td th:text="${job.jobClass}" style="word-break: break-all;"></td>
                <td th:text="${job.cronExpression}"></td>
                <td th:text="${job.description}"></td>
                <td>
                    <span th:switch="${job.triggerState}" class="badge"
                          th:classappend="${job.triggerState == 'NORMAL' ? 'bg-success' : (job.triggerState == 'PAUSED' ? 'bg-warning text-dark' : (job.triggerState == 'ERROR' ? 'bg-danger' : (job.triggerState == 'COMPLETE' ? 'bg-info text-dark' : (job.triggerState == 'BLOCKED' ? 'bg-secondary' : 'bg-light text-dark'))))}">
                        <span th:case="'NORMAL'">NORMAL</span>
                        <span th:case="'PAUSED'">PAUSED</span>
                        <span th:case="'ERROR'">ERROR</span>
                        <span th:case="'COMPLETE'">COMPLETE</span>
                        <span th:case="'BLOCKED'">BLOCKED</span>
                        <span th:case="*">[[${job.triggerState}]]</span>
                    </span>
                </td>
                <td th:text="${job.nextFireTime != null ? #temporals.format(job.nextFireTime, 'yyyy-MM-dd HH:mm:ss') : 'N/A'}"></td>
                <td th:text="${job.previousFireTime != null ? #temporals.format(job.previousFireTime, 'yyyy-MM-dd HH:mm:ss') : 'N/A'}"></td>
                <td>
                    <div class="btn-group" role="group">
                        <form th:action="@{/jobs/pause}" method="post" class="d-inline me-1" th:if="${job.triggerState == 'NORMAL' or job.triggerState == 'BLOCKED'}">
                            <input type="hidden" name="jobName" th:value="${job.jobName}" />
                            <input type="hidden" name="jobGroup" th:value="${job.jobGroup}" />
                            <button type="submit" class="btn btn-sm btn-warning" title="Pause"><i class="fas fa-pause"></i></button>
                        </form>
                        <form th:action="@{/jobs/resume}" method="post" class="d-inline me-1" th:if="${job.triggerState == 'PAUSED'}">
                            <input type="hidden" name="jobName" th:value="${job.jobName}" />
                            <input type="hidden" name="jobGroup" th:value="${job.jobGroup}" />
                            <button type="submit" class="btn btn-sm btn-success" title="Resume"><i class="fas fa-play"></i></button>
                        </form>
                        <form th:action="@{/jobs/delete}" method="post" class="d-inline">
                            <input type="hidden" name="jobName" th:value="${job.jobName}" />
                            <input type="hidden" name="jobGroup" th:value="${job.jobGroup}" />
                            <button type="submit" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this job?');"><i class="fas fa-trash"></i></button>
                        </form>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handlers to sortable columns
            document.querySelectorAll('th.sortable').forEach(header => {
                header.addEventListener('click', function() {
                    const sortField = this.dataset.sort;
                    let sortOrder = 'asc';

                    // Toggle sort order if clicking the same column
                    if (this.classList.contains('sorted')) {
                        sortOrder = this.classList.contains('sort-asc') ? 'desc' : 'asc';
                    }

                    // Get current URL and update with sort parameters
                    const url = new URL(window.location.href);
                    url.searchParams.set('sort', sortField);
                    url.searchParams.set('order', sortOrder);

                    // Reload the page with new sort parameters
                    window.location.href = url.toString();
                });

                // Add cursor pointer to indicate sortable columns
                header.style.cursor = 'pointer';
            });
        });
    </script>

    <style>
        th.sortable {
            position: relative;
            padding-right: 25px !important;
        }
        th.sortable i {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }
        th.sortable:hover i {
            opacity: 1;
        }
        th.sorted i {
            opacity: 1;
        }
        th.sort-asc .fa-sort-up,
        th.sort-desc .fa-sort-down {
            display: inline-block !important;
        }
        th.sort-asc .fa-sort,
        th.sort-desc .fa-sort,
        .fa-sort-up,
        .fa-sort-down {
            display: none !important;
        }
    </style>
</th:block>
</body>
</html>
